(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[32],{26:(e,a,t)=>{Promise.resolve().then(t.bind(t,8497))},786:(e,a,t)=>{"use strict";t.d(a,{A:()=>l,O:()=>n});var r=t(5155),o=t(2115);let s=(0,o.createContext)();function n(e){let{children:a}=e,[t,n]=(0,o.useState)(null),[l,c]=(0,o.useState)(!0);return(0,o.useEffect)(()=>{(async()=>{try{let e=await fetch("".concat("https://backendsebas-ehe6b0e6eebbhjhe.mexicocentral-01.azurewebsites.net","/usuarios/verificar"),{credentials:"include"});if(e.ok){let a=await e.json();n(a.usuario)}else n(null)}catch(e){console.error("Error verificando sesi\xf3n:",e)}finally{c(!1)}})()},[]),(0,r.jsx)(s.Provider,{value:{usuario:t,setUsuario:n,cargando:l},children:a})}function l(){return(0,o.useContext)(s)}},5695:(e,a,t)=>{"use strict";var r=t(8999);t.o(r,"usePathname")&&t.d(a,{usePathname:function(){return r.usePathname}}),t.o(r,"useRouter")&&t.d(a,{useRouter:function(){return r.useRouter}}),t.o(r,"useSearchParams")&&t.d(a,{useSearchParams:function(){return r.useSearchParams}})},8497:(e,a,t)=>{"use strict";t.r(a),t.d(a,{default:()=>i});var r=t(5155),o=t(2115),s=t(5695),n=t(5799);function l(e){let{usuario:a}=e,[t,s]=(0,o.useState)(null),[l,c]=(0,o.useState)([]),[i,d]=(0,o.useState)([]),[u,h]=(0,o.useState)(0),[m,p]=(0,o.useState)("efectivo"),[x,b]=(0,o.useState)(""),[v,f]=(0,o.useState)(""),[j,g]=(0,o.useState)(""),[N,y]=(0,o.useState)(null),[w,S]=(0,o.useState)(Date.now()),E="https://backendsebas-ehe6b0e6eebbhjhe.mexicocentral-01.azurewebsites.net";(0,o.useEffect)(()=>{(async()=>{try{let e=await fetch("".concat(E,"/eventos/activo"),{credentials:"include"});if(!e.ok)throw Error("No hay evento activo");let a=await e.json();s(a.id)}catch(e){console.error("Error al obtener evento activo:",e),n.oR.error("No hay evento activo disponible.")}})()},[]),(0,o.useEffect)(()=>{(async()=>{try{let e=await fetch("".concat(E,"/productos")),a=await e.json();c(a)}catch(e){n.oR.error("Error al cargar productos")}})()},[]),(0,o.useEffect)(()=>{h(i.reduce((e,a)=>{let t=a.paraLlevar?100*a.cantidad:0;return e+a.precio*a.cantidad+t},0))},[i]);let k=e=>{d(a=>[...a,{...e,cantidad:1,paraLlevar:!1}])},C=(e,a)=>{a<1||d(t=>t.map((t,r)=>r===e?{...t,cantidad:a}:t))},P=e=>{d(a=>a.map((a,t)=>t===e?{...a,paraLlevar:!a.paraLlevar}:a))},R=e=>{d(a=>a.filter((a,t)=>t!==e))},L=async()=>{if(!t)return void n.oR.error("No hay evento activo para asociar la venta");if(!j.trim())return void n.oR.error("Debe ingresar el nombre del cliente");if("efectivo"===m&&(!x||Number(x)<u))return void n.oR.error("Debe ingresar un monto v\xe1lido para el pago en efectivo");if("sinpe"===m&&""===v.trim())return void n.oR.error("Debe ingresar el comprobante de la transferencia SINPE");try{let e=await fetch("".concat(E,"/ventas"),{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({productos:i.map(e=>({id:e.id,cantidad:e.cantidad,precio:e.precio,paraLlevar:e.paraLlevar})),forma_pago:m,comprobante:"sinpe"===m?v:null,monto_pagado:"efectivo"===m?Number(x):null,nombre_cliente:j.trim(),evento_id:t})}),a=await e.json();if(!e.ok)throw Error(a.error||"Error al registrar la venta");n.oR.success("Venta registrada con \xe9xito"),"efectivo"===m&&void 0!==a.vuelto&&(y(a.vuelto),n.oR.info("Vuelto: ₡".concat(Number(a.vuelto).toLocaleString())),setTimeout(()=>y(null),4e3)),d([]),h(0),p("efectivo"),b(""),f(""),g(""),S(Date.now()),setTimeout(()=>{window.open("".concat(E,"/comandas/").concat(a.venta_id),"_blank")},100)}catch(e){console.error(e),n.oR.error("Error al procesar la venta, no hay caja abierta")}};return(0,r.jsxs)("div",{className:"max-w-5xl mx-auto p-6 bg-gris-piedra shadow rounded space-y-6",children:[(0,r.jsx)("h2",{className:"text-2xl font-bold text-black",children:"Realizar Venta"}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"font-semibold block mb-1",children:"Nombre del Cliente:"}),(0,r.jsx)("input",{type:"text",value:j,onChange:e=>g(e.target.value),placeholder:"Ej: Mar\xeda Rodr\xedguez",className:"border p-2 rounded w-full sm:w-96",autoComplete:"off"})]}),(0,r.jsx)("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:l.map(e=>(0,r.jsxs)("div",{className:"border rounded p-3 hover:bg-gray-50 cursor-pointer relative ".concat(e.cantidad<=10?"border-red-500":""),onClick:()=>k(e),children:[(0,r.jsx)("p",{className:"font-semibold",children:e.nombre}),(0,r.jsxs)("p",{className:"text-sm text-gray-600",children:["₡",e.precio]}),e.cantidad<=10&&(0,r.jsxs)("span",{className:"absolute top-2 right-2 text-xs bg-red-500 text-white px-2 py-0.5 rounded",children:["Stock bajo (",e.cantidad,")"]})]},e.id+Math.random()))}),(0,r.jsxs)("div",{className:"mt-6",children:[(0,r.jsx)("h3",{className:"text-xl font-bold mb-2",children:"Productos Seleccionados"}),0===i.length?(0,r.jsx)("p",{className:"text-gray-500",children:"No hay productos a\xfan."}):(0,r.jsxs)("table",{className:"w-full text-left border-t",children:[(0,r.jsx)("thead",{children:(0,r.jsxs)("tr",{className:"text-gray-700",children:[(0,r.jsx)("th",{className:"py-2",children:"Producto"}),(0,r.jsx)("th",{children:"Cantidad"}),(0,r.jsx)("th",{children:"Precio"}),(0,r.jsx)("th",{children:"Subtotal"}),(0,r.jsx)("th",{children:"Para llevar"}),(0,r.jsx)("th",{})]})}),(0,r.jsx)("tbody",{children:i.map((e,a)=>(0,r.jsxs)("tr",{className:"border-t",children:[(0,r.jsx)("td",{className:"py-2",children:e.nombre}),(0,r.jsx)("td",{children:(0,r.jsx)("input",{type:"number",value:e.cantidad,onChange:e=>C(a,parseInt(e.target.value)),className:"w-16 border rounded p-1",min:"1"})}),(0,r.jsxs)("td",{children:["₡",e.precio]}),(0,r.jsxs)("td",{children:["₡",(e.precio*e.cantidad+(e.paraLlevar?100*e.cantidad:0)).toLocaleString(),e.paraLlevar&&(0,r.jsxs)("span",{className:"block text-xs text-gray-500",children:["(+₡",100*e.cantidad," por empaque)"]})]}),(0,r.jsx)("td",{children:(0,r.jsxs)("label",{className:"flex items-center gap-1 text-sm",children:[(0,r.jsx)("input",{type:"checkbox",checked:e.paraLlevar,onChange:()=>P(a)}),"Para llevar"]})}),(0,r.jsx)("td",{children:(0,r.jsx)("button",{onClick:()=>R(a),className:"text-red-600 hover:underline",children:"Eliminar"})})]},a))})]})]}),(0,r.jsxs)("div",{className:"text-right text-xl font-bold text-primario",children:["Total: ₡",u.toLocaleString()]}),(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"font-semibold block mb-1",children:"Forma de Pago:"}),(0,r.jsxs)("select",{value:m,onChange:e=>p(e.target.value),className:"border p-2 rounded w-full sm:w-64",children:[(0,r.jsx)("option",{value:"efectivo",children:"Efectivo"}),(0,r.jsx)("option",{value:"sinpe",children:"Transferencia SINPE"})]})]}),"efectivo"===m&&(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"font-semibold block mb-1",children:"Monto entregado:"}),(0,r.jsx)("input",{type:"number",min:u,value:x,onChange:e=>b(e.target.value),className:"border p-2 rounded w-full sm:w-64"}),x&&Number(x)>=u&&(0,r.jsxs)("p",{className:"mt-1 text-green-600 font-medium",children:["Vuelto: ₡",(Number(x)-u).toLocaleString()]})]}),"sinpe"===m&&(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"font-semibold block mb-1",children:"Comprobante SINPE:"}),(0,r.jsx)("input",{type:"text",value:v,onChange:e=>f(e.target.value),placeholder:"Ej: SINPE #123456",className:"border p-2 rounded w-full sm:w-96",autoComplete:"off"})]})]}),(0,r.jsxs)("div",{className:"text-right",children:[(0,r.jsx)("button",{onClick:L,disabled:0===i.length,className:"bg-oro-liturgico text-white px-6 py-2 rounded btn-personalizado disabled:opacity-50",children:"Confirmar Venta"}),null!==N&&"efectivo"===m&&(0,r.jsxs)("div",{className:"mt-2 text-green-700 font-semibold",children:["Vuelto entregado: ₡",Number(N).toLocaleString()]})]})]},w)}var c=t(786);function i(){let{usuario:e,cargando:a}=(0,c.A)(),t=(0,s.useRouter)();return((0,o.useEffect)(()=>{a||e&&["admin","coordinador","voluntario"].includes(e.rol)||t.push("/")},[e,a,t]),a||!e)?null:(0,r.jsx)("main",{className:"p-4 bg-oro-liturgico",children:(0,r.jsx)(l,{usuario:e})})}}},e=>{var a=a=>e(e.s=a);e.O(0,[799,441,684,358],()=>a(26)),_N_E=e.O()}]);